# Alertmanager Configuration — Enterprise Architecture Platform
#
# Routing tree:
#   severity=critical  -> webhook (PagerDuty/Slack) + email
#   severity=warning   -> email only
#   component=slo      -> dedicated SLO channel
#
# Inhibition rules prevent warning noise when critical alerts fire.

global:
  resolve_timeout: 5m
  smtp_smarthost: "${SMTP_HOST}:${SMTP_PORT}"
  smtp_from: "alertmanager@enterprise-agents.local"
  smtp_auth_username: "${SMTP_USER}"
  smtp_auth_password: "${SMTP_PASSWORD}"
  smtp_require_tls: true

# Templates for notification formatting
templates:
  - "/etc/alertmanager/templates/*.tmpl"

route:
  # Default receiver for unmatched alerts
  receiver: email-ops
  group_by: ["alertname", "severity", "component"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # Critical alerts -> webhook + email (immediate)
    - match:
        severity: critical
      receiver: critical-webhook-and-email
      group_wait: 10s
      repeat_interval: 1h
      continue: false

    # SLO burn rate alerts -> dedicated SLO channel
    - match:
        component: slo
      receiver: slo-webhook
      group_wait: 30s
      repeat_interval: 2h
      continue: false

    # Warning alerts -> email only
    - match:
        severity: warning
      receiver: email-ops
      group_wait: 1m
      repeat_interval: 4h
      continue: false

receivers:
  # Email-only receiver for warnings and fallback
  - name: email-ops
    email_configs:
      - to: "ops-team@enterprise-agents.local"
        send_resolved: true
        headers:
          Subject: "[{{ .Status | toUpper }}] {{ .GroupLabels.alertname }} - Enterprise Platform"

  # Webhook + email for critical alerts
  - name: critical-webhook-and-email
    webhook_configs:
      - url: "${ALERTMANAGER_WEBHOOK_URL}"
        send_resolved: true
        max_alerts: 10
    email_configs:
      - to: "oncall@enterprise-agents.local"
        send_resolved: true
        headers:
          Subject: "[CRITICAL] {{ .GroupLabels.alertname }} - Enterprise Platform"

  # SLO-specific webhook (e.g., dedicated Slack channel)
  - name: slo-webhook
    webhook_configs:
      - url: "${SLO_WEBHOOK_URL}"
        send_resolved: true
        max_alerts: 5

# Inhibition rules — suppress lower-severity alerts when higher-severity fires
inhibit_rules:
  # If HighErrorRate (critical) fires, suppress SLO burn rate warnings
  - source_match:
      severity: critical
      alertname: HighErrorRate
    target_match:
      component: slo
    equal: ["platform"]

  # If OOMKills (critical) fires, suppress HighCPU (warning)
  - source_match:
      severity: critical
      alertname: OOMKills
    target_match:
      severity: warning
      alertname: HighCPU
    equal: ["platform"]
