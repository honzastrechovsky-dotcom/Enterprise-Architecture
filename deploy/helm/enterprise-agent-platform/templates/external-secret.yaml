{{- if .Values.secrets.useExternalSecret }}
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: {{ include "enterprise-agent-platform.fullname" . }}
  labels:
    {{- include "enterprise-agent-platform.labels" . | nindent 4 }}
spec:
  refreshInterval: {{ .Values.secrets.externalSecret.refreshInterval | default "1h" }}
  secretStoreRef:
    name: {{ .Values.secrets.externalSecret.storeName | default (printf "%s-azure-kv" .Release.Name) }}
    kind: {{ .Values.secrets.externalSecret.storeKind | default "SecretStore" }}
  target:
    name: {{ include "enterprise-agent-platform.fullname" . }}
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        secret-key: '{{ "{{ .secret_key }}" }}'
        database-url: 'postgresql+asyncpg://{{ .Values.postgresql.auth.username }}:{{ "{{ .postgres_password }}" }}@{{ include "enterprise-agent-platform.fullname" . }}-postgresql:5432/{{ .Values.postgresql.auth.database }}'
        dev-jwt-secret: '{{ "{{ .jwt_secret }}" }}'
        litellm-api-key: '{{ "{{ .litellm_master_key }}" }}'
  data:
    - secretKey: secret_key
      remoteRef:
        key: secret-key
    - secretKey: postgres_password
      remoteRef:
        key: postgres-password
    - secretKey: redis_password
      remoteRef:
        key: redis-password
    - secretKey: litellm_master_key
      remoteRef:
        key: litellm-master-key
    - secretKey: jwt_secret
      remoteRef:
        key: jwt-secret
{{- end }}
